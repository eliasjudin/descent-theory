name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: leanprover/lean-action@v1
      - name: Build matrix (canonical + strict gates)
        run: |
          set -euo pipefail
          : > ci-build.log
          run_and_log() {
            echo "=== $1 ===" | tee -a ci-build.log
            shift
            "$@" 2>&1 | tee -a ci-build.log
          }

          run_and_log "lake build" lake build
          run_and_log "lake build Descent.All" lake build Descent.All
          run_and_log "lake lint" lake lint
          run_and_log "lake exe lint-style Descent" lake exe lint-style Descent
          run_and_log "lake test" lake test

          if bash scripts/ci_high_risk_gate.sh; then
            run_and_log "high-risk: lake build Descent.FiberedCategory.Descent.SingleMorphismComparison" \
              lake build Descent.FiberedCategory.Descent.SingleMorphismComparison
            run_and_log "high-risk: lake build Descent.CategoryTheory.FiberedCategory.PseudofunctorOfFibers" \
              lake build Descent.CategoryTheory.FiberedCategory.PseudofunctorOfFibers
            run_and_log "high-risk: lake build Descent.Pseudofunctor.Descent.CechDescentDataEquiv" \
              lake build Descent.Pseudofunctor.Descent.CechDescentDataEquiv
          else
            echo "No high-risk Lean edits; skipping expanded targeted builds." | tee -a ci-build.log
          fi
      - name: Warning gate (non-sorry + exact SORRY_TRACKER allowlist)
        run: |
          set -euo pipefail
          bash scripts/ci_warning_gate.sh ci-build.log SORRY_TRACKER.md
